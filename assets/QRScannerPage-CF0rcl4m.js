const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-tv4amMDG.js","assets/vendor-Bxm2pvdK.js"])))=>i.map(i=>d[i]);
import{t as Q,h as z,B as v,k as f,_ as Y,a as Z}from"./index-C-Wz0jPL.js";import{j as e}from"./query-By2FkZ5k.js";import{r as n}from"./vendor-Bxm2pvdK.js";import{Q as M,a8 as ee,a9 as se,t as I,S as P,aa as E,ab as S,A,m as D,ac as H,a as te,q as ae,ad as re,U as ne,s as ce,y as ie}from"./ui-BgMx_JBB.js";function xe(){const[t,d]=n.useState(!1),[c,m]=n.useState(""),[y,j]=n.useState(!1),[l,k]=n.useState(!1),[i,w]=n.useState([]),[x,B]=n.useState(!0),[u,b]=n.useState(null),[p,_]=n.useState(null),g=n.useRef(null),T=n.useRef(!1),X=n.useRef(""),N=n.useRef(null),R=n.useCallback(s=>{w(r=>[s,...r].slice(0,50)),_(s)},[]),L=n.useCallback(s=>{if(x)try{const r=new AudioContext,a=r.createOscillator();s==="success"?(a.type="sine",a.frequency.value=800):(a.type="square",a.frequency.value=300),a.connect(r.destination),a.start(),setTimeout(()=>a.stop(),s==="success"?150:300)}catch{}},[x]),q=n.useCallback(async s=>{var r,a,h;if(!T.current&&X.current!==s){T.current=!0,X.current=s,j(!0),b(null);try{const{data:o}=await Q.validateQR(s),C=(r=o.data)==null?void 0:r.ticket;R({code:s,status:"success",message:"Check-in thành công!",ticket:C,timestamp:new Date}),L("success"),z.success("Check-in thành công!")}catch(o){const C=((h=(a=o.response)==null?void 0:a.data)==null?void 0:h.message)||"Vé không hợp lệ";R({code:s,status:"error",message:C,timestamp:new Date}),L("error"),z.error(C)}finally{j(!1),T.current=!1,N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{X.current=""},3e3)}}},[R,L]),V=async()=>{var r,a;const s=c.trim();if(s){k(!0),b(null),_(null);try{const{data:h}=await Q.getTicketInfo(s),o=h.data;b(o)}catch(h){const o=((a=(r=h.response)==null?void 0:r.data)==null?void 0:a.message)||"Không tìm thấy vé";z.error(o)}finally{k(!1)}}},O=async()=>{u&&(await q(u.ticket_code),b(null),m(""))},U=async s=>{s.preventDefault(),c.trim()&&(await q(c.trim()),m(""))},F=async()=>{try{const{Html5Qrcode:s}=await Y(async()=>{const{Html5Qrcode:a}=await import("./index-tv4amMDG.js");return{Html5Qrcode:a}},__vite__mapDeps([0,1])),r=new s("qr-reader");g.current=r,await r.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},a=>{q(a)},()=>{}),d(!0)}catch{z.error("Không thể truy cập camera")}},$=async()=>{if(g.current)try{await g.current.stop(),g.current=null}catch{}d(!1)};n.useEffect(()=>()=>{if(g.current)try{g.current.stop()}catch{}N.current&&clearTimeout(N.current)},[]);const G=i.filter(s=>s.status==="success").length,J=i.filter(s=>s.status==="error").length;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(M,{className:"size-6"}),"Quét QR Check-in"]}),e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>B(s=>!s),children:x?e.jsx(ee,{className:"size-4"}):e.jsx(se,{className:"size-4"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-6",children:[e.jsxs("div",{className:"bg-card border border-border rounded-xl p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:i.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Đã quét"})]}),e.jsxs("div",{className:"bg-green-500/10 border border-green-500/20 rounded-xl p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:G}),e.jsx("p",{className:"text-xs text-green-600",children:"Thành công"})]}),e.jsxs("div",{className:"bg-red-500/10 border border-red-500/20 rounded-xl p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-red-500",children:J}),e.jsx("p",{className:"text-xs text-red-500",children:"Lỗi"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-card border border-border rounded-xl p-4",children:[e.jsxs("h2",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(I,{className:"size-4"}),"Camera"]}),e.jsx("div",{id:"qr-reader",className:"w-full aspect-square bg-black/5 rounded-lg overflow-hidden mb-4"}),e.jsxs(v,{onClick:t?$:F,variant:t?"destructive":"default",className:"w-full gap-2",size:"lg",children:[e.jsx(I,{className:"size-4"}),t?"Dừng quét":"Bắt đầu quét"]})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-4",children:[e.jsxs("h2",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(P,{className:"size-4"}),"Nhập mã vé"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{type:"text",value:c,onChange:s=>{m(s.target.value.toUpperCase()),b(null),_(null)},placeholder:"EVT-XXXXXXXX-XXXXXXXX",className:"w-full h-11 px-4 rounded-lg border border-input bg-background font-mono text-sm focus:ring-2 focus:ring-ring outline-none",onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),V())}}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{onClick:V,variant:"outline",className:"flex-1 gap-2",disabled:!c.trim()||l,children:[l?e.jsx(E,{className:"size-4 animate-spin"}):e.jsx(P,{className:"size-4"}),"Tra cứu"]}),e.jsxs(v,{onClick:U,className:"flex-1 gap-2",disabled:!c.trim()||y,children:[y?e.jsx(E,{className:"size-4 animate-spin"}):e.jsx(S,{className:"size-4"}),"Check-in ngay"]})]})]})]}),e.jsx(A,{children:u&&e.jsx(D.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsx(K,{ticket:u,mode:"preview",onCheckIn:u.status==="valid"?O:void 0,loading:y})})}),e.jsx(A,{children:p&&!u&&e.jsx(D.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:p.status==="success"&&p.ticket?e.jsx(K,{ticket:p.ticket,mode:"checked-in"}):e.jsx("div",{className:"bg-red-500/5 border border-red-500/20 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"size-10 rounded-full bg-red-500/10 flex items-center justify-center shrink-0",children:e.jsx(H,{className:"size-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-red-600",children:"Check-in thất bại"}),e.jsx("p",{className:"text-sm text-red-500 mt-0.5",children:p.message}),e.jsx("p",{className:"text-xs text-muted-foreground font-mono mt-1",children:p.code})]})]})})})})]}),e.jsxs("div",{className:"bg-card border border-border rounded-xl p-4",children:[e.jsxs("h2",{className:"font-semibold mb-4",children:["Lịch sử quét (",i.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto scrollbar-thin",children:i.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Chưa có lượt quét nào"}):i.map(s=>{var r,a;return e.jsxs(D.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},className:f("flex items-start gap-3 p-3 rounded-lg border",s.status==="success"?"bg-green-500/5 border-green-500/20":"bg-red-500/5 border-red-500/20"),children:[s.status==="success"?e.jsx(S,{className:"size-5 text-green-600 shrink-0 mt-0.5"}):e.jsx(H,{className:"size-5 text-red-500 shrink-0 mt-0.5"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-mono text-xs",children:s.code}),e.jsx("span",{className:f("text-[10px] font-medium px-1.5 py-0.5 rounded-full shrink-0",s.status==="success"?"bg-green-500/10 text-green-600":"bg-red-500/10 text-red-500"),children:s.status==="success"?"OK":"LỖI"})]}),e.jsx("p",{className:"text-sm mt-0.5",children:s.message}),s.ticket&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1 space-y-0.5",children:[e.jsx("p",{className:"font-medium text-foreground/80",children:(r=s.ticket.event)==null?void 0:r.title}),e.jsxs("p",{children:[(a=s.ticket.ticket_type)==null?void 0:a.name,s.ticket.buyer&&e.jsxs(e.Fragment,{children:[" • ",s.ticket.buyer.full_name]}),s.ticket.seat&&e.jsxs(e.Fragment,{children:[" • ",s.ticket.seat.room," ",s.ticket.seat.row,"-",s.ticket.seat.number]})]})]}),e.jsx("p",{className:"text-[10px] text-muted-foreground mt-1",children:s.timestamp.toLocaleTimeString("vi-VN")})]})]},`${s.code}-${s.timestamp.getTime()}`)})})]})]})]})}function K({ticket:t,mode:d,onCheckIn:c,loading:m}){var i,w,x;const j={valid:{label:"Hợp lệ",color:"bg-green-500/10 text-green-600 border-green-500/20"},used:{label:"Đã sử dụng",color:"bg-gray-500/10 text-gray-500 border-gray-500/20"},cancelled:{label:"Đã huỷ",color:"bg-red-500/10 text-red-500 border-red-500/20"}}[t.status]||{label:t.status,color:"bg-muted text-muted-foreground"},l=d==="checked-in",k=d==="preview"&&t.status==="valid"&&c;return e.jsxs("div",{className:f("border rounded-xl overflow-hidden",l?"bg-green-500/5 border-green-500/30":"bg-card border-border"),children:[e.jsxs("div",{className:f("px-4 py-3 flex items-center gap-3",l?"bg-green-500/10":"bg-muted/30 border-b border-border"),children:[l?e.jsx("div",{className:"size-8 rounded-full bg-green-500/20 flex items-center justify-center",children:e.jsx(S,{className:"size-5 text-green-600"})}):e.jsx("div",{className:"size-8 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(M,{className:"size-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:f("font-semibold text-sm",l&&"text-green-700"),children:l?"Check-in thành công!":"Thông tin vé"}),e.jsx("p",{className:"font-mono text-xs text-muted-foreground",children:t.ticket_code})]}),e.jsx("span",{className:f("text-xs font-medium px-2.5 py-1 rounded-full border",j.color),children:j.label})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[t.event&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-semibold text-base",children:t.event.title}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1.5 text-sm text-muted-foreground",children:[t.event.start_time&&e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(te,{className:"size-3.5"}),Z(t.event.start_time)]}),t.event.location&&e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(ae,{className:"size-3.5"}),t.event.location]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-muted/40 rounded-lg px-3 py-2",children:[e.jsx(re,{className:"size-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:"Loại vé"}),e.jsx("p",{className:"font-medium truncate",children:((i=t.ticket_type)==null?void 0:i.name)||"—"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-muted/40 rounded-lg px-3 py-2",children:[e.jsx(ne,{className:"size-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:"Người mua"}),e.jsx("p",{className:"font-medium truncate",children:((w=t.buyer)==null?void 0:w.full_name)||"—"})]})]}),t.seat&&e.jsxs("div",{className:"flex items-center gap-2 bg-muted/40 rounded-lg px-3 py-2",children:[e.jsx(ce,{className:"size-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:"Chỗ ngồi"}),e.jsxs("p",{className:"font-medium",children:[t.seat.room," • ",t.seat.row," - Số ",t.seat.number]})]})]}),t.used_at&&e.jsxs("div",{className:"flex items-center gap-2 bg-muted/40 rounded-lg px-3 py-2",children:[e.jsx(ie,{className:"size-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:"Check-in lúc"}),e.jsx("p",{className:"font-medium",children:new Date(t.used_at).toLocaleString("vi-VN")})]})]}),((x=t.buyer)==null?void 0:x.email)&&e.jsx("div",{className:"col-span-2 flex items-center gap-2 bg-muted/40 rounded-lg px-3 py-2",children:e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:"Email"}),e.jsx("p",{className:"font-medium text-sm",children:t.buyer.email})]})})]}),k&&e.jsxs(v,{onClick:c,disabled:m,className:"w-full gap-2 mt-2",size:"lg",children:[m?e.jsx(E,{className:"size-4 animate-spin"}):e.jsx(S,{className:"size-4"}),"Xác nhận Check-in"]}),d==="preview"&&t.status==="used"&&e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/20 text-amber-700 rounded-lg px-4 py-3 text-sm text-center",children:[e.jsx("p",{className:"font-semibold",children:"⚠️ Vé đã được sử dụng"}),t.used_at&&e.jsxs("p",{className:"text-xs mt-1",children:["Lúc: ",new Date(t.used_at).toLocaleString("vi-VN")]})]}),d==="preview"&&t.status==="cancelled"&&e.jsx("div",{className:"bg-red-500/10 border border-red-500/20 text-red-600 rounded-lg px-4 py-3 text-sm text-center",children:e.jsx("p",{className:"font-semibold",children:"❌ Vé đã bị huỷ"})})]})]})}export{xe as default};
