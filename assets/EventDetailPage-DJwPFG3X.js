import{j as e,u as me,a as Q}from"./query-By2FkZ5k.js";import{r as b,f as ue,u as xe}from"./vendor-Bxm2pvdK.js";import{u as he,g as fe,a as R,c as T,B as E,h as k,o as ee,e as ge,r as pe}from"./index-C-Wz0jPL.js";import{M as be}from"./Modal-ydqTrkrt.js";import{S as K}from"./Skeleton-ChbfH6PQ.js";import{s as je,m as ye,j as ve,l as Ne,h as we,a as ke,q as _e,T as Se}from"./ui-BgMx_JBB.js";function Te({room:f,selectedSeats:z,onSeatToggle:O,maxSelectable:C,soldSeats:P=[]}){const S=b.useMemo(()=>{const u={};if(!f.seats)return u;const x=new Set;return f.seats.forEach(i=>{!i||!i.row||!i.id||x.has(i.id)||(x.add(i.id),u[i.row]||(u[i.row]=[]),u[i.row].push(i))}),Object.keys(u).forEach(i=>{u[i].sort((N,w)=>N.number-w.number)}),u},[f.seats]),I=b.useMemo(()=>Object.keys(S).sort((u,x)=>{const i=parseInt(u.replace(/[^\d]/g,""),10),N=parseInt(x.replace(/[^\d]/g,""),10);return!isNaN(i)&&!isNaN(N)?i-N:u.localeCompare(x)}),[S]),v=u=>z.some(x=>x.id===u.id);return e.jsxs("div",{className:"flex flex-col items-center mt-6 w-full max-w-full overflow-x-auto pb-4 custom-scrollbar",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h4",{className:"font-semibold text-center mb-1 flex items-center justify-center gap-2",children:[e.jsx(je,{className:"size-4 text-primary"}),f.name]}),e.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs mt-2 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"size-4 rounded bg-emerald-500"}),e.jsx("span",{children:"Trống"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"size-4 rounded bg-primary"}),e.jsx("span",{children:"Đang chọn"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"size-4 rounded bg-muted-foreground/30"}),e.jsx("span",{children:"Đã bán/Khóa"})]})]})]}),e.jsxs("div",{className:"w-fit mx-auto min-w-full px-4 flex flex-col items-center",children:[e.jsxs("div",{className:"w-full max-w-md mx-auto mb-10 flex flex-col items-center",children:[e.jsx("div",{className:"w-full h-1.5 bg-gradient-to-b from-primary/40 to-transparent rounded-t-full shadow-[0_0_15px_rgba(var(--primary),0.3)]"}),e.jsx("div",{className:"w-full flex justify-center mt-1 border-t border-primary/20 bg-muted/20 backdrop-blur-sm rounded-b-[100%] pb-1",children:e.jsx("p",{className:"text-[10px] font-semibold tracking-[0.2em] text-muted-foreground uppercase pt-1",children:"Màn hình"})})]}),e.jsx("div",{className:"flex flex-col gap-2.5",children:I.map(u=>{const x=S[u];return e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("span",{className:"w-12 text-center text-xs font-semibold text-muted-foreground shrink-0",children:u}),e.jsx("div",{className:"flex gap-1.5",children:x.map((i,N)=>{const w=v(i),j=i.isActive&&!P.includes(`${i.row}-${i.number}`),A=j&&(w||z.length<C);return e.jsx("button",{onClick:()=>O(i),disabled:!j||!w&&z.length>=C,className:`size-7 sm:size-8 rounded-md flex items-center justify-center text-[10px] sm:text-xs font-medium transition-all relative ${w?"bg-primary text-primary-foreground shadow-sm ring-2 ring-primary ring-offset-1 ring-offset-background hover:bg-primary/90 hover:shadow-md":j?"bg-emerald-500/90 text-white hover:bg-emerald-600 hover:shadow-md":"bg-muted-foreground/30 text-muted-foreground/50 cursor-not-allowed"} ${!A&&!w?"opacity-50 cursor-not-allowed hover:bg-emerald-500/90":""}`,title:j?`${i.row} - Số ${i.number}`:"Ghế không khả dụng",children:i.number},`${i.id}-${N}`)})})]},u)})})]})]})}function Be(){var V,U,D,H,X,J,W,Y,Z;const{id:f}=ue(),z=xe(),{isAuthenticated:O,user:C}=he(),P=me(),[S,I]=b.useState(!1),[v,u]=b.useState({}),[x,i]=b.useState([]),[N,w]=b.useState(!1),[j,A]=b.useState(1),[$,q]=b.useState(0),{data:t,isLoading:se}=Q({queryKey:["event",f],queryFn:()=>ge.getEventById(f).then(s=>s.data.data),enabled:!!f}),{data:M,isLoading:te}=Q({queryKey:["rooms"],queryFn:()=>pe.getRooms().then(s=>s.data),enabled:S}),{data:L}=Q({queryKey:["sold-seats",f],queryFn:()=>ee.getSoldSeats(f).then(s=>s.data),enabled:S&&!!f}),ne=se,h=b.useMemo(()=>!t||!M?null:(Array.isArray(M)?M:M.data||[]).find(n=>{var r;return(r=n.events)==null?void 0:r.some(d=>d.id===t.id||d._id===t.id)}),[t,M]),re=Array.isArray(L==null?void 0:L.data)?L.data:[],p=Object.values(v).reduce((s,n)=>s+n,0),G=(s,n)=>{var c;const r=(c=t==null?void 0:t.ticket_types)==null?void 0:c.find(a=>(a._id||a.id)===s),d=(r==null?void 0:r.max_per_user)??-1;u(a=>{const m=Math.max(0,n);if(d!==-1&&m>d)return k.info(`Loại vé này chỉ cho phép mua tối đa ${d} vé mỗi người`),a;const o={...a,[s]:m};return i(y=>{const _=y.filter(F=>F.ticketTypeId===s);if(m<_.length){const F=_.slice(0,m);return[...y.filter(oe=>oe.ticketTypeId!==s),...F]}return y}),o})},ae=s=>{i(n=>{if(n.find(d=>d.seat.id===s.id))return n.filter(d=>d.seat.id!==s.id);{const c=t.ticket_types.filter(a=>{var y;const m=((y=s.locks)==null?void 0:y.filter(_=>_.eventId===f))||[];return m.length===0?!0:m.some(_=>!_.ticketTypeId)?!1:m.some(_=>_.ticketTypeId===(a._id||a.id))}).map(a=>a._id||a.id).find(a=>{const m=n.filter(y=>y.ticketTypeId===a).length,o=v[a]||0;return m<o});return c?[...n,{seat:s,ticketTypeId:c}]:(k.info("Bạn cần chọn thêm số lượng loại vé tương ứng với khu vực ghế này trước khi chọn tĩnh."),n)}})},l=b.useMemo(()=>{if(!h)return null;const s=Object.entries(v).filter(([,r])=>r>0).map(([r])=>r),n=h.seats.map(r=>{var c;if(!r.isActive)return r;const d=((c=r.locks)==null?void 0:c.filter(a=>a.eventId===f))||[];return d.length>0?d.some(o=>!o.ticketTypeId)?{...r,isActive:!1}:d.some(o=>s.includes(o.ticketTypeId))?{...r,isActive:!0}:{...r,isActive:!1}:r});return{...h,seats:n}},[h,v,f]),B=((V=t==null?void 0:t.ticket_types)==null?void 0:V.reduce((s,n)=>s+(v[n._id||n.id]||0)*n.price,0))||0,g=b.useMemo(()=>{if(!t)return[];const s=t.banner_image||t.bannerImage||"",n=t.sub_banners||t.subBanners||[];return t.show_sub_banners!==!1&&t.showSubBanners!==!1?[s,...n].filter(Boolean):[s].filter(Boolean)},[t]);b.useEffect(()=>{if(g.length<=1)return;const s=setInterval(()=>{q(n=>(n+1)%g.length)},5e3);return()=>clearInterval(s)},[g.length]);const ie=()=>{g.length<=1||q(s=>(s+1)%g.length)},le=()=>{g.length<=1||q(s=>(s-1+g.length)%g.length)},ce=s=>{q(s)},de=async()=>{var r,d,c;if(!O){k.error("Vui lòng đăng nhập để mua vé");return}const s=Object.entries(v).filter(([,a])=>a>0).map(([a,m])=>{const o=t.ticket_types.find(y=>(y._id||y.id)===a);return{ticket_type_id:a,ticket_type_name:o==null?void 0:o.name,quantity:m,unit_price:o==null?void 0:o.price}});if(s.length===0){k.error("Vui lòng chọn ít nhất 1 vé");return}if(h&&((r=l==null?void 0:l.seats)==null?void 0:r.some(a=>a.isActive))&&x.length!==p){k.error(`Vui lòng chọn đủ ${p} ghế tương ứng với số vé.`);return}w(!0);try{const a=x.map(m=>({roomName:(h==null?void 0:h.name)||"Phòng chiếu",row:m.seat.row,number:m.seat.number,ticket_type_id:m.ticketTypeId}));await ee.createOrder({event_id:f,items:s,seat_assignments:a.length>0?a:void 0,buyer_info:C?{fullName:C.full_name,email:C.email}:void 0,event_snapshot:{title:t.title,startTime:t.start_time||t.startTime,endTime:t.end_time||t.endTime,location:t.location,bannerImage:t.banner_image||t.bannerImage}}),k.success("Mua vé thành công!"),P.invalidateQueries({queryKey:["event",f]}),I(!1),u({}),i([]),A(1),z("/my-tickets")}catch(a){k.error(((c=(d=a.response)==null?void 0:d.data)==null?void 0:c.message)||"Mua vé thất bại")}finally{w(!1)}};return ne?e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6 space-y-4",children:[e.jsx(K,{className:"w-full aspect-video rounded-xl"}),e.jsx(K,{className:"h-8 w-3/4"}),e.jsx(K,{className:"h-4 w-1/2"}),e.jsx(K,{className:"h-32 w-full"})]}):t?e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6",children:[e.jsxs(ye.div,{initial:{opacity:0},animate:{opacity:1},children:[e.jsx("div",{className:"w-full bg-black/5 dark:bg-black/20 rounded-xl shadow-md overflow-hidden relative flex items-center justify-center aspect-[21/9] sm:aspect-[3/1] sm:max-h-[500px]",children:g.length>0?e.jsxs(e.Fragment,{children:[g.map((s,n)=>e.jsx("div",{className:"absolute inset-0 transition-opacity duration-1000 ease-in-out",style:{opacity:n===$?1:0,zIndex:n===$?1:0},children:e.jsx("img",{src:fe(s,{width:1200}),alt:`${t.title} - ảnh ${n+1}`,className:"w-full h-full object-contain bg-black/5 dark:bg-black/20",crossOrigin:"anonymous"})},n)),g.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-16 bg-gradient-to-r from-black/30 to-transparent z-10 flex items-center justify-start pl-2",children:e.jsx("button",{onClick:le,className:"size-10 rounded-full bg-white/20 backdrop-blur-sm text-white flex items-center justify-center hover:bg-white/40 transition-all active:scale-90 cursor-pointer",children:e.jsx(ve,{className:"size-5"})})}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-black/30 to-transparent z-10 flex items-center justify-end pr-2",children:e.jsx("button",{onClick:ie,className:"size-10 rounded-full bg-white/20 backdrop-blur-sm text-white flex items-center justify-center hover:bg-white/40 transition-all active:scale-90 cursor-pointer",children:e.jsx(Ne,{className:"size-5"})})}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 z-10",children:[e.jsx("div",{className:"w-full h-1 bg-white/20",children:e.jsx("div",{className:"h-full bg-white/80 transition-none",style:{animation:"progress-fill 5s linear infinite"}},`prog-${$}`)}),e.jsxs("div",{className:"flex items-center justify-center gap-3 py-2 bg-gradient-to-t from-black/50 to-transparent",children:[e.jsx("div",{className:"flex items-center gap-2",children:g.map((s,n)=>e.jsx("button",{onClick:()=>ce(n),className:`rounded-full cursor-pointer transition-all duration-300 ${n===$?"w-6 h-2 bg-white shadow-md":"size-2 bg-white/40 hover:bg-white/80"}`},n))}),e.jsxs("span",{className:"text-white/70 text-[10px] font-medium tabular-nums",children:[$+1,"/",g.length]})]})]})]})]}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center text-muted-foreground p-12",children:[e.jsx(we,{className:"size-12 mb-3 opacity-20"}),e.jsx("p",{children:"Chưa có ảnh sự kiện"})]})}),e.jsx("style",{children:`
          @keyframes progress-fill {
            from { width: 0%; }
            to { width: 100%; }
          }
        `}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold",children:t.title}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-4 text-sm text-muted-foreground",children:[(t.start_time||t.startTime)&&e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(ke,{className:"size-4"}),R(t.start_time||t.startTime),(t.end_time||t.endTime)&&` - ${R(t.end_time||t.endTime)}`]}),t.location&&e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(_e,{className:"size-4"}),t.location]})]})]}),t.description&&e.jsx("div",{className:"mt-6 prose prose-sm dark:prose-invert max-w-none",children:e.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:t.description})}),t.content&&e.jsx("div",{className:"mt-6 prose prose-sm dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:t.content}}),t.ticket_types&&t.ticket_types.length>0&&e.jsxs("div",{className:"mt-8",children:[e.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(Se,{className:"size-5"}),"Loại vé"]}),e.jsx("div",{className:"space-y-3",children:t.ticket_types.map(s=>{const n=s._id||s.id;return e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border border-border bg-card",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:s.name}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5",children:s.description}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"text-primary font-bold",children:T(s.price)}),s.original_price>s.price&&e.jsx("span",{className:"text-xs text-muted-foreground line-through",children:T(s.original_price)})]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s.quantity_total===-1?"Không giới hạn":`Còn: ${Math.max(0,(s.quantity_total||0)-(s.quantity_sold||0))}`})]},n)})}),e.jsx(E,{onClick:()=>I(!0),size:"lg",className:"w-full mt-6",children:"Mua vé ngay"})]})]}),e.jsx(be,{isOpen:S,onClose:()=>{I(!1),i([]),A(1)},title:j===1?"Bước 1: Chọn vé & Chỗ ngồi":"Bước 2: Xác nhận thanh toán",size:"lg",children:e.jsxs("div",{className:`flex flex-col ${j===1&&h&&((U=l==null?void 0:l.seats)!=null&&U.some(s=>s.isActive))?"md:flex-row":""} gap-6 ${j===1&&h&&((D=l==null?void 0:l.seats)!=null&&D.some(s=>s.isActive))?"h-[75vh] md:h-auto":""} overflow-hidden`,children:[j===1&&e.jsxs("div",{className:`${h&&((H=l==null?void 0:l.seats)!=null&&H.some(s=>s.isActive))?"flex-1 border-r border-border pr-6":"w-full"} overflow-y-auto custom-scrollbar`,children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Số lượng vé"}),e.jsx("div",{className:"space-y-4",children:(X=t.ticket_types)==null?void 0:X.map(s=>{var m;const n=s._id||s.id,r=s.quantity_total===-1,d=r?1/0:Math.max(0,(s.quantity_total||0)-(s.quantity_sold||0)),c=v[n]||0,a=x.filter(o=>o.ticketTypeId===n).length;return e.jsxs("div",{className:"flex flex-col py-3 border-b border-border last:border-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-foreground",children:s.name}),e.jsx("p",{className:"font-bold text-sm text-muted-foreground",children:T(s.price)})]}),e.jsxs("div",{className:"flex items-center gap-2 relative z-10",children:[e.jsx("button",{onClick:o=>{o.stopPropagation(),G(n,c-1)},disabled:c===0,className:"size-8 rounded-lg border border-input flex items-center justify-center hover:bg-muted disabled:opacity-40",children:"−"}),e.jsx("span",{className:"w-8 text-center font-medium",children:c}),e.jsx("button",{onClick:o=>{o.stopPropagation(),G(n,c+1)},disabled:!r&&c>=d||s.max_per_user!==-1&&c>=s.max_per_user,className:"size-8 rounded-lg border border-input flex items-center justify-center hover:bg-muted disabled:opacity-40 flex-shrink-0",children:"+"})]})]}),h&&((m=l==null?void 0:l.seats)==null?void 0:m.some(o=>o.isActive))&&c>0&&e.jsxs("div",{className:"text-right mt-1 text-xs",children:[e.jsx("span",{className:"text-muted-foreground mr-1",children:"Đã xếp chỗ:"}),e.jsxs("span",{className:`font-bold ${a===c?"text-emerald-500":"text-amber-500"}`,children:[a," / ",c]})]})]},n)})}),B>0&&e.jsxs("div",{className:"mt-4 p-4 rounded-xl bg-primary/5 border border-primary/20",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Số vé đã chọn:"}),e.jsxs("span",{className:"font-semibold",children:[p," vé"]})]}),h&&((J=l==null?void 0:l.seats)==null?void 0:J.some(s=>s.isActive))&&e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Số ghế đã xếp:"}),e.jsxs("span",{className:`font-semibold ${x.length===p?"text-emerald-500":"text-amber-500"}`,children:[x.length," / ",p," ghế"]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-primary/10",children:[e.jsx("span",{className:"font-medium",children:"Tạm tính:"}),e.jsx("span",{className:"text-xl font-bold text-primary",children:T(B)})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsxs(E,{onClick:()=>{var n;if(p===0){k.error("Vui lòng chọn ít nhất 1 vé");return}if(h&&((n=l==null?void 0:l.seats)==null?void 0:n.some(r=>r.isActive))&&x.length!==p){k.error(`Vui lòng chọn đủ ${p} ghế trên sơ đồ bên phải tương ứng với số lượng vé.`);return}A(2)},disabled:B===0||(h&&(W=l==null?void 0:l.seats)!=null&&W.some(s=>s.isActive)?x.length!==p:!1),className:"w-full",children:["Tiếp tục thanh toán ",T(B)]})})]}),j===1&&h&&((Y=l==null?void 0:l.seats)==null?void 0:Y.some(s=>s.isActive))&&e.jsxs("div",{className:"flex-[1.5] flex flex-col items-center bg-muted/20 border border-border rounded-xl p-4 overflow-y-auto custom-scrollbar relative",children:[e.jsxs("div",{className:"w-full flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Sơ đồ ghế ngồi"}),p>0?e.jsxs("span",{className:"text-xs bg-primary/10 text-primary px-3 py-1.5 rounded-full font-medium border border-primary/20",children:["Vui lòng nhấp vào ",p," ghế"]}):e.jsx("span",{className:"text-xs bg-amber-500/10 text-amber-500 px-3 py-1.5 rounded-full font-medium border border-amber-500/20",children:"Hãy chọn số lượng vé trước"})]}),te?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:"Đang tải sơ đồ..."}):e.jsx(Te,{room:l||h,selectedSeats:x.map(s=>s.seat),onSeatToggle:ae,maxSelectable:p,soldSeats:re})]}),j===2&&e.jsxs("div",{className:"w-full mx-auto max-w-lg",children:[e.jsxs("div",{className:"mb-6 pb-6 border-b border-border",children:[e.jsx("h3",{className:"font-bold text-xl mb-4 text-center",children:"Xác nhận thông tin"}),e.jsx("div",{className:"space-y-3",children:(Z=t.ticket_types)==null?void 0:Z.map(s=>{const n=s._id||s.id,r=v[n]||0;if(r===0)return null;const d=x.filter(c=>c.ticketTypeId===n);return e.jsxs("div",{className:"flex flex-col bg-muted/30 p-3 rounded-lg border border-border",children:[e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsxs("span",{children:[s.name," (",r," vé)"]}),e.jsx("span",{className:"text-primary",children:T(s.price*r)})]}),d.length>0&&e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Ghế: ",d.map(c=>`${c.seat.row} - Số ${c.seat.number}`).join(", ")]})]},n)})})]}),e.jsx("div",{className:"p-5 rounded-xl bg-primary/10 border border-primary/20 mb-6",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-lg",children:"Tổng thanh toán:"}),e.jsx("span",{className:"text-2xl font-bold text-primary",children:T(B)})]})}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(E,{variant:"outline",onClick:()=>A(1),className:"flex-1",disabled:N,children:"Quay lại chọn vé"}),e.jsx(E,{onClick:de,loading:N,className:"flex-[2]",size:"lg",children:"Thanh toán ngay"})]})]})]})})]}):e.jsx("div",{className:"flex items-center justify-center min-h-[60vh] text-muted-foreground",children:"Không tìm thấy sự kiện"})}export{Be as default};
