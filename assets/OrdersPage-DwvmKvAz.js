import{u as U,a as C,b as w,j as t}from"./query-By2FkZ5k.js";import{r as d}from"./vendor-Bxm2pvdK.js";import{B as u,k as z,f as J,h as i,o as H,t as L,m as W,e as Y}from"./index-CUfHF9RD.js";import{T as Z}from"./Skeleton-l4uPorLi.js";import{S as x}from"./Select-B-0jrKDi.js";import{M as P}from"./Modal-BdgH8NYW.js";import{O as ee,S as te,a2 as Q,V as B}from"./ui-BgMx_JBB.js";function ce(){const[b,G]=d.useState(""),[f,I]=d.useState(""),[S,T]=d.useState(1),[v,h]=d.useState(!1),[a,o]=d.useState({user_id:"",event_id:"",ticket_type_id:"",quantity:1}),[c,p]=d.useState(null),[r,g]=d.useState({status:"",seat_row:"",seat_number:""}),j=U(),{data:N,isLoading:R}=C({queryKey:["admin","tickets",{search:b,status:f,page:S}],queryFn:()=>L.getTickets({search:b,status:f||void 0,page:S,limit:20}).then(e=>e.data)}),{data:y}=C({queryKey:["admin","users","all"],queryFn:()=>W.getUsers({limit:100}).then(e=>e.data),enabled:v}),{data:_}=C({queryKey:["admin","events","all",{status:""}],queryFn:()=>Y.getEvents({limit:100,status:""}).then(e=>e.data),enabled:v}),q=(N==null?void 0:N.data)||[],A=(y==null?void 0:y.data)||[],F=(_==null?void 0:_.data)||[],M={valid:"bg-green-500/10 text-green-600 border-green-500/20",used:"bg-gray-500/10 text-gray-500 border-gray-500/20",cancelled:"bg-red-500/10 text-red-500 border-red-500/20"},k=F.find(e=>e.id===a.event_id),E=(k==null?void 0:k.ticket_types)||[],O=w({mutationFn:async()=>{const e=E.find(n=>n.id===a.ticket_type_id||n._id===a.ticket_type_id);if(!e)throw new Error("Vui lòng chọn loại vé");const s={user_id:a.user_id,event_id:a.event_id,payment_method:"free",items:[{ticket_type_id:e.id||e._id,ticket_type_name:e.name,quantity:a.quantity,unit_price:e.price}]};return H.createOrder(s)},onSuccess:()=>{i.success("Cấp vé thành công!"),h(!1),j.invalidateQueries({queryKey:["admin","tickets"]}),o({user_id:"",event_id:"",ticket_type_id:"",quantity:1})},onError:e=>{var s,n;i.error(((n=(s=e.response)==null?void 0:s.data)==null?void 0:n.message)||"Có lỗi khi cấp vé. Thử lại sau.")}}),D=()=>{if(!a.user_id||!a.event_id||!a.ticket_type_id||a.quantity<1){i.error("Vui lòng điền đủ thông tin để cấp vé");return}O.mutate()},X=w({mutationFn:e=>H.deleteOrder(e),onSuccess:()=>{i.success("Xóa đơn hàng thành công!"),j.invalidateQueries({queryKey:["admin","tickets"]})},onError:()=>i.error("Có lỗi xảy ra khi xóa đơn hàng")}),$=w({mutationFn:()=>{const e={status:r.status};return r.seat_row&&r.seat_number&&(e.seatSnapshot={...c.seat,row:r.seat_row,number:parseInt(r.seat_number)}),L.updateTicket(c.id,e)},onSuccess:()=>{i.success("Cập nhật vé thành công!"),p(null),j.invalidateQueries({queryKey:["admin","tickets"]})},onError:()=>i.error("Có lỗi xảy ra khi cập nhật vé")}),K=e=>{if(!e){i.error("Lỗi: Vé này không thuộc đơn hàng nào");return}window.confirm("Bạn có chắc chắn muốn xóa TOÀN BỘ đơn hàng và TẤT CẢ vé trong đơn này không? Chỗ ngồi sẽ được giải phóng.")&&X.mutate(e)},V=e=>{var s,n,l;p(e),g({status:e.status,seat_row:((s=e.seat)==null?void 0:s.row)||"",seat_number:((l=(n=e.seat)==null?void 0:n.number)==null?void 0:l.toString())||""})};return t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-6",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Quản lý đơn hàng (Vé đã bán)"}),t.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Danh sách tất cả các vé khách hàng đã mua hoặc được cấp"})]}),t.jsxs(u,{onClick:()=>h(!0),className:"gap-2 shrink-0",children:[t.jsx(ee,{className:"size-4"})," Cấp vé"]})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mb-4",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground"}),t.jsx("input",{type:"text",placeholder:"Tìm mã vé...",value:b,onChange:e=>{G(e.target.value),T(1)},className:"w-full h-10 pl-10 pr-4 rounded-lg border border-input bg-background outline-none focus:ring-2 focus:ring-ring text-sm"})]}),t.jsx(x,{value:f,onChange:e=>{I(e),T(1)},placeholder:"Tất cả trạng thái",className:"w-48",options:[{value:"",label:"Tất cả trạng thái"},{value:"valid",label:"Hợp lệ"},{value:"used",label:"Đã sử dụng"},{value:"cancelled",label:"Đã hủy"}]})]}),t.jsx("div",{className:"hidden md:block bg-card border border-border rounded-xl overflow-hidden",children:t.jsxs("table",{className:"w-full text-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"border-b border-border bg-muted/50",children:[t.jsx("th",{className:"text-left p-3 font-medium",children:"Mã vé"}),t.jsx("th",{className:"text-left p-3 font-medium",children:"Người mua"}),t.jsx("th",{className:"text-left p-3 font-medium",children:"T.Tin Vé & Chỗ"}),t.jsx("th",{className:"text-left p-3 font-medium",children:"Sự kiện"}),t.jsx("th",{className:"text-left p-3 font-medium",children:"Trạng thái"}),t.jsx("th",{className:"text-left p-3 font-medium",children:"Ngày tạo"}),t.jsx("th",{className:"text-center p-3 font-medium",children:"Hành động"})]})}),t.jsx("tbody",{children:R?Array.from({length:5}).map((e,s)=>t.jsx(Z,{},s)):q.map(e=>{var s,n,l,m;return t.jsxs("tr",{className:"border-b border-border last:border-0 hover:bg-muted/30",children:[t.jsx("td",{className:"p-3 font-mono text-xs max-w-[120px] truncate",title:e.order_id?`Đơn ID: ${e.order_id}`:"",children:e.ticket_code}),t.jsxs("td",{className:"p-3",children:[t.jsx("p",{className:"font-medium text-xs truncate max-w-[150px]",children:((s=e.buyer)==null?void 0:s.full_name)||"—"}),t.jsx("p",{className:"text-[10px] text-muted-foreground truncate max-w-[150px]",children:(n=e.buyer)==null?void 0:n.email})]}),t.jsxs("td",{className:"p-3",children:[t.jsx("p",{className:"font-medium text-xs",children:((l=e.ticket_type)==null?void 0:l.name)||"—"}),e.seat&&t.jsxs("span",{className:"text-[10px] text-primary bg-primary/10 px-1.5 py-0.5 rounded mt-0.5 inline-block",children:[e.seat.room," • ",e.seat.row," - Số ",e.seat.number]})]}),t.jsx("td",{className:"p-3 text-muted-foreground text-xs max-w-[200px] truncate",children:((m=e.event)==null?void 0:m.title)||"—"}),t.jsx("td",{className:"p-3",children:t.jsx("span",{className:z("text-xs font-medium px-2 py-0.5 rounded-full border",M[e.status]),children:e.status})}),t.jsx("td",{className:"p-3 text-muted-foreground text-xs",children:e.created_at?J(e.created_at):"—"}),t.jsx("td",{className:"p-3",children:t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[t.jsx("button",{onClick:()=>V(e),className:"text-blue-500 hover:text-blue-600 bg-blue-500/10 p-1.5 rounded",title:"Sửa trạng thái & chỗ ngồi",children:t.jsx(Q,{className:"size-4"})}),t.jsx("button",{onClick:()=>K(e.order_id),className:"text-red-500 hover:text-red-600 bg-red-500/10 p-1.5 rounded",title:"Xóa toàn bộ đơn",children:t.jsx(B,{className:"size-4"})})]})})]},e.id||e.ticket_code)})})]})}),t.jsx("div",{className:"md:hidden space-y-3",children:q.map(e=>{var s,n,l,m;return t.jsx("div",{className:"bg-card border border-border rounded-xl p-4",children:t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs("p",{className:"font-mono text-xs",children:[e.ticket_code," ",e.order_id&&t.jsxs("span",{className:"text-muted-foreground/50 text-[10px]",children:["(Đơn: ",e.order_id.substring(0,6),"...)"]})]}),t.jsxs("div",{className:"mt-1 flex items-center gap-1.5 text-xs",children:[t.jsx("span",{className:"font-medium",children:((s=e.buyer)==null?void 0:s.full_name)||"—"}),((n=e.buyer)==null?void 0:n.email)&&t.jsxs("span",{className:"text-muted-foreground text-[10px]",children:["(",e.buyer.email,")"]})]}),t.jsx("p",{className:"text-sm font-medium mt-1 truncate",children:((l=e.event)==null?void 0:l.title)||"—"}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:[((m=e.ticket_type)==null?void 0:m.name)||"—"," ",e.seat&&`• ${e.seat.room} ${e.seat.row} - Số ${e.seat.number}`]})]}),t.jsxs("div",{className:"flex flex-col items-end gap-2",children:[t.jsx("span",{className:z("shrink-0 text-[10px] font-medium px-2 py-0.5 rounded-full border",M[e.status]),children:e.status}),t.jsxs("div",{className:"flex gap-2 mt-1",children:[t.jsx("button",{onClick:()=>V(e),className:"text-blue-500 bg-blue-500/10 p-1.5 rounded",children:t.jsx(Q,{className:"size-3"})}),t.jsx("button",{onClick:()=>K(e.order_id),className:"text-red-500 bg-red-500/10 p-1.5 rounded",children:t.jsx(B,{className:"size-3"})})]})]})]})},e.id||e.ticket_code)})}),t.jsx(P,{isOpen:v,onClose:()=>h(!1),title:"Cấp vé thủ công",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Người dùng nhận vé"}),t.jsx(x,{value:a.user_id,onChange:e=>o(s=>({...s,user_id:e})),placeholder:"-- Chọn khách hàng --",options:[{value:"",label:"-- Chọn khách hàng --"},...A.map(e=>({value:e.id,label:`${e.full_name} (${e.email})`}))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Sự kiện"}),t.jsx(x,{value:a.event_id,onChange:e=>o(s=>({...s,event_id:e,ticket_type_id:""})),placeholder:"-- Chọn sự kiện --",options:[{value:"",label:"-- Chọn sự kiện --"},...F.map(e=>({value:e.id,label:e.title}))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Loại vé"}),t.jsx(x,{value:a.ticket_type_id,onChange:e=>o(s=>({...s,ticket_type_id:e})),placeholder:"-- Chọn loại vé --",options:[{value:"",label:"-- Chọn loại vé --"},...E.map(e=>({value:e.id||e._id,label:`${e.name} - ${e.price.toLocaleString("vi-VN")}đ (Còn: ${e.quantity_total})`}))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Số lượng vé muốn cấp"}),t.jsx("input",{type:"number",min:1,max:100,value:a.quantity,onChange:e=>o(s=>({...s,quantity:parseInt(e.target.value)||1})),className:"w-full h-10 px-3 rounded-lg border border-input bg-background outline-none focus:ring-2 focus:ring-ring text-sm"})]}),t.jsxs("div",{className:"pt-4 flex gap-3",children:[t.jsx(u,{onClick:D,loading:O.isPending,className:"flex-1",children:"Cấp ngay"}),t.jsx(u,{variant:"outline",onClick:()=>h(!1),className:"flex-1",children:"Hủy"})]})]})}),t.jsx(P,{isOpen:!!c,onClose:()=>p(null),title:"Sửa vé Khách hàng",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Trạng thái vé"}),t.jsx(x,{value:r.status,onChange:e=>g(s=>({...s,status:e})),options:[{value:"valid",label:"Hợp lệ (valid)"},{value:"used",label:"Đã sử dụng (used)"},{value:"cancelled",label:"Đã hủy (cancelled)"}]}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Lưu ý: Hủy vé sẽ giải phóng chỗ ngồi này cho người khác."})]}),(c==null?void 0:c.seat)&&t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Hàng ghế (Row)"}),t.jsx("input",{type:"text",value:r.seat_row,onChange:e=>g(s=>({...s,seat_row:e.target.value})),className:"w-full h-10 px-3 rounded-lg border border-input bg-background outline-none focus:ring-2 focus:ring-ring text-sm",maxLength:20})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Số ghế (Number)"}),t.jsx("input",{type:"number",value:r.seat_number,onChange:e=>g(s=>({...s,seat_number:e.target.value})),className:"w-full h-10 px-3 rounded-lg border border-input bg-background outline-none focus:ring-2 focus:ring-ring text-sm",min:1})]})]}),t.jsxs("div",{className:"pt-4 flex gap-3",children:[t.jsx(u,{onClick:()=>$.mutate(),loading:$.isPending,className:"flex-1",children:"Cập nhật"}),t.jsx(u,{variant:"outline",onClick:()=>p(null),className:"flex-1",children:"Đóng"})]})]})})]})}export{ce as default};
